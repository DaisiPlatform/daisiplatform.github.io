<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NZD Exchange Rates — RBNZ B1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    header { display:flex; gap:16px; flex-wrap:wrap; align-items:center; }
    h1 { font-size:1.3rem; margin:0; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; }
    select, input { padding:6px 10px; border-radius:8px; border:1px solid #ccc; }
    #chart { width:100%; height:70vh; margin-top:16px; }
    footer { margin-top: 8px; font-size: .85rem; color:#666; }
  </style>
</head>
<body>
  <header>
    <h1>NZD Exchange Rates — RBNZ B1</h1>
    <div class="controls">
      <label>Series: <select id="series"></select></label>
      <label>Start: <input id="start" type="date"></label>
      <label>End: <input id="end" type="date"></label>
      <button id="refresh">Update</button>
    </div>
  </header>
  <div id="chart"></div>
  <footer>
    Source: Reserve Bank of New Zealand — B1 Exchange rates & TWI (daily).
  </footer>

<script>
(async function () {
  const URL = "https://www.rbnz.govt.nz/-/media/project/sites/rbnz/files/statistics/series/b/b1/hb1-daily.xlsx";
  const buf = await fetch(URL).then(r => r.arrayBuffer());
  const wb = XLSX.read(buf, { type: "array" });
  const ws = wb.Sheets[wb.SheetNames[0]];
  let df = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });
  const headerIdx = df.findIndex(row => row.some(v => String(v).trim().toLowerCase() === "date"));
  const headers = df[headerIdx].map(h => String(h||"").trim());
  const dateColIdx = headers.findIndex(h => h.toLowerCase() === "date");
  const rows = df.slice(headerIdx+1).filter(r => r.some(v => v!=null && v!==""));
  const records = rows.map(r => {
    const o={}; headers.forEach((h,i)=>o[h]=r[i]);
    let d=o[headers[dateColIdx]];
    if(typeof d==="number"){ d=new Date(Date.UTC(1899,11,30)+d*86400000);}
    else{ d=new Date(d);}
    o.Date=d; return o;
  }).filter(r=>!isNaN(r.Date));

  const allCols = headers.filter(h=>h && h.toLowerCase()!=="date");
  const seriesSel=document.getElementById("series");
  allCols.forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;seriesSel.appendChild(o)});
  seriesSel.value=allCols.find(c=>c.toLowerCase().includes("united states"))||allCols[0];

  const min=new Date(Math.min(...records.map(r=>r.Date)));
  const max=new Date(Math.max(...records.map(r=>r.Date)));
  const fmt=d=>d.toISOString().slice(0,10);
  const startEl=document.getElementById("start"), endEl=document.getElementById("end");
  startEl.value=fmt(new Date(max.getTime()-365*86400000)); startEl.min=fmt(min); startEl.max=fmt(max);
  endEl.value=fmt(max); endEl.min=fmt(min); endEl.max=fmt(max);
  document.getElementById("refresh").onclick=draw;
  draw();

  function draw(){
    const s=seriesSel.value;
    const start=new Date(startEl.value), end=new Date(endEl.value);
    const pts=records.filter(r=>r.Date>=start&&r.Date<=end)
                     .map(r=>({x:r.Date,y:+r[s]}))
                     .filter(p=>!isNaN(p.y));
    Plotly.newPlot("chart",[{
      x:pts.map(p=>p.x),y:pts.map(p=>p.y),
      type:"scatter",mode:"lines",line:{width:2},
      hovertemplate:"%{x|%Y-%m-%d}<br>"+s+": %{y:.4f}<extra></extra>"
    }],{title:`${s} vs NZD (Daily)`,hovermode:"x unified"});
  }
})();
</script>
</body>
</html>
